// Generated by CoffeeScript 1.10.0
var myApp;

myApp = angular.module('starter.controllers', ['ionic']);

myApp.saveData = function(key, value) {
  window.localStorage[key] = JSON.stringify(value);
  return JSON.parse(window.localStorage[key] || '{}');
};

myApp.settings = JSON.parse(window.localStorage.settings || '{}');

myApp.controller('DashCtrl', function($scope, $ionicLoading) {
  var baseWeatherURL, convertKelvinToCelsius, convertKelvinToFahrenheit, processWeatherData, saveWeatherData;
  baseWeatherURL = 'http://api.openweathermap.org/data/2.5/weather';
  $scope.weatherData = JSON.parse(window.localStorage['weatherData'] || '[]');
  console.log($scope.weatherData);
  convertKelvinToFahrenheit = function(K) {
    return Math.floor((K - 273.15) * 1.8000 + 32.00);
  };
  convertKelvinToCelsius = function(K) {
    return Math.floor(K - 273.15);
  };
  saveWeatherData = function(data) {
    debugger;
    var datum, i, len, weatherData;
    weatherData = JSON.parse(window.localStorage['weatherData'] || '[]');
    if (weatherData.length > 0) {
      for (i = 0, len = weatherData.length; i < len; i++) {
        datum = weatherData[i];
        if (data.name === datum.name) {
          weatherData[datum] = data;
          myApp.saveData('weatherData', weatherData);
          return $scope.weatherData = weatherData;
        }
      }
    }
    weatherData.push(data);
    myApp.saveData('weatherData', weatherData);
    return $scope.weatherData = weatherData;
  };
  processWeatherData = function(data) {
    var temperature_mode, weatherData;
    temperature_mode = myApp.settings.fahrenheit || true;
    if (temperature_mode) {
      weatherData = {
        name: data.name,
        description: data.weather[0].description,
        temp: convertKelvinToFahrenheit(data.main.temp),
        temp_min: convertKelvinToFahrenheit(data.main.temp_min),
        temp_max: convertKelvinToFahrenheit(data.main.temp_max)
      };
    } else {
      weatherData = {
        name: data.name,
        description: data.weather[0].description,
        temp: convertKelvinToCelsius(data.main.temp),
        temp_min: convertKelvinToCelsius(data.main.temp_min),
        temp_max: convertKelvinToCelsius(data.main.temp_max)
      };
    }
    return weatherData;
  };
  return $scope.weatherPoll = function(zip, region) {
    if (region == null) {
      region = 'us';
    }
    $ionicLoading.show({
      template: 'Loading...'
    });
    return $.ajax({
      url: baseWeatherURL,
      type: 'get',
      data: {
        zip: zip,
        region: region,
        APPID: 'dd9f3e622ff8e3dde48856f172b598d8'
      },
      error: function(error) {
        $ionicLoading.hide();
        return console.log(error);
      },
      success: function(data) {
        var weatherData;
        $ionicLoading.hide();
        weatherData = processWeatherData(data);
        return $scope.weatherData = saveWeatherData(weatherData);
      }
    });
  };
});

myApp.controller('ChatsCtrl', function($scope, Chats) {
  $scope.chats = Chats.all();
  return $scope.remove = function(chat) {
    return Chats.remove(chat);
  };
});

myApp.controller('ChatDetailCtrl', function($scope, $stateParams, Chats) {
  return $scope.chat = Chats.get($stateParams.chatId);
});

myApp.controller('AccountCtrl', function($scope) {
  $scope.watchCollection('settings', function() {
    var settings;
    myApp.saveData('settings', $scope.settings);
    settings = $scope.settings;
    return console.log(settings);
  });
  $scope.settings = JSON.parse(window.localStorage['settings'] || '{}');
  if ($scope.settings == null) {
    return $scope.settings = {
      enableFriends: true,
      fahrenheit: true
    };
  }
});
